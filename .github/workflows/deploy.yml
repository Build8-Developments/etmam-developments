name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_target:
        description: "What to deploy"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - frontend
          - strapi

env:
  NODE_VERSION: "20.x"

jobs:
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    environment: production
    if: github.event_name == 'push' || github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'frontend'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Create production .env file
        working-directory: frontend
        run: |
          cat > .env.production << EOF
          # Production Environment Variables
          NEXT_PUBLIC_APP_URL=${{ secrets.FRONTEND_NEXT_PUBLIC_APP_URL }}
          NEXT_PUBLIC_SITE_URL=${{ secrets.FRONTEND_NEXT_PUBLIC_APP_URL }}

          # Strapi URLs (Client-side)
          NEXT_PUBLIC_STRAPI_API_URL=${{ secrets.FRONTEND_NEXT_PUBLIC_STRAPI_API_URL }}
          NEXT_PUBLIC_STRAPI_GRAPHQL_URL=${{ secrets.FRONTEND_NEXT_PUBLIC_STRAPI_API_URL }}/graphql

          # Strapi URLs (Server-side)
          STRAPI_API_URL=${{ secrets.STRAPI_API_URL }}
          STRAPI_GRAPHQL_URL=${{ secrets.STRAPI_GRAPHQL_URL }}

          # API Tokens
          NEXT_PUBLIC_STRAPI_API_TOKEN=${{ secrets.FRONTEND_NEXT_PUBLIC_STRAPI_API_TOKEN }}
          STRAPI_API_TOKEN=${{ secrets.STRAPI_API_TOKEN }}

          # Revalidation
          REVALIDATION_SECRET=${{ secrets.FRONTEND_REVALIDATION_SECRET }}

          # Feature Flags
          NEXT_PUBLIC_ENABLE_ANALYTICS=true
          NEXT_PUBLIC_ENABLE_PWA=true
          NEXT_PUBLIC_ENABLE_DARK_MODE=false
          NEXT_PUBLIC_ENABLE_NOTIFICATIONS=true
          EOF

      - name: Build Next.js application
        working-directory: frontend
        run: npm run build

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy to production server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          # Create backup directory name with timestamp
          BACKUP_DIR="/var/www/backups/frontend-$(date +%Y%m%d-%H%M%S)"

          # Create deployment script
          cat > deploy-frontend.sh << 'SCRIPT'
          #!/bin/bash
          set -e

          echo "üöÄ Starting frontend deployment..."

          # Create backups directory if it doesn't exist
          mkdir -p /var/www/backups

          # Backup current deployment
          if [ -d "/var/www/etmam-frontend/.next" ]; then
            echo "üì¶ Creating backup..."
            BACKUP_DIR="/var/www/backups/frontend-$(date +%Y%m%d-%H%M%S)"
            mkdir -p "$BACKUP_DIR"
            cp -r /var/www/etmam-frontend/.next "$BACKUP_DIR/" 2>/dev/null || true
            cp /var/www/etmam-frontend/.env.production "$BACKUP_DIR/" 2>/dev/null || true
            echo "‚úÖ Backup created at: $BACKUP_DIR"
          fi

          # Navigate to deployment directory
          cd /var/www/etmam-frontend

          # Stop PM2 process gracefully
          echo "‚è∏Ô∏è  Stopping PM2 process..."
          pm2 stop etmam-frontend || true

          # Clean old build
          echo "üßπ Cleaning old build..."
          rm -rf .next

          echo "‚úÖ Deployment preparation complete"
          SCRIPT

          chmod +x deploy-frontend.sh

          # Execute deployment preparation on server
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p ${SSH_PORT:-22} ${SSH_USER}@${SSH_HOST} 'bash -s' < deploy-frontend.sh

          # Sync built files to server
          echo "üì§ Syncing files to server..."

          # Sync .next folder
          sshpass -p "$SSH_PASSWORD" rsync -avz -e "ssh -o StrictHostKeyChecking=no -p ${SSH_PORT:-22}" \
            --delete \
            frontend/.next/ ${SSH_USER}@${SSH_HOST}:/var/www/etmam-frontend/.next/

          # Sync public folder
          sshpass -p "$SSH_PASSWORD" rsync -avz -e "ssh -o StrictHostKeyChecking=no -p ${SSH_PORT:-22}" \
            --delete \
            frontend/public/ ${SSH_USER}@${SSH_HOST}:/var/www/etmam-frontend/public/

          # Sync source files
          sshpass -p "$SSH_PASSWORD" rsync -avz -e "ssh -o StrictHostKeyChecking=no -p ${SSH_PORT:-22}" \
            --delete \
            frontend/src/ ${SSH_USER}@${SSH_HOST}:/var/www/etmam-frontend/src/

          # Sync configuration files
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -P ${SSH_PORT:-22} \
            frontend/package.json \
            frontend/package-lock.json \
            frontend/next.config.ts \
            frontend/tsconfig.json \
            frontend/postcss.config.mjs \
            frontend/eslint.config.mjs \
            frontend/ecosystem.config.js \
            ${SSH_USER}@${SSH_HOST}:/var/www/etmam-frontend/

          # Sync .env.production
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -P ${SSH_PORT:-22} \
            frontend/.env.production \
            ${SSH_USER}@${SSH_HOST}:/var/www/etmam-frontend/.env.production

          # Create post-deployment script
          cat > post-deploy-frontend.sh << 'SCRIPT'
          #!/bin/bash
          set -e

          cd /var/www/etmam-frontend

          # Install production dependencies
          echo "üì¶ Installing production dependencies..."
          npm ci --production --ignore-scripts

          # Start PM2 process
          echo "‚ñ∂Ô∏è  Starting PM2 process..."
          pm2 start ecosystem.config.js || pm2 restart etmam-frontend

          # Save PM2 configuration
          pm2 save

          # Show PM2 status
          echo "üìä PM2 Status:"
          pm2 list

          echo "‚úÖ Frontend deployment complete!"
          SCRIPT

          chmod +x post-deploy-frontend.sh

          # Execute post-deployment on server
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p ${SSH_PORT:-22} ${SSH_USER}@${SSH_HOST} 'bash -s' < post-deploy-frontend.sh

          echo "üéâ Frontend deployed successfully!"

  deploy-strapi:
    name: Deploy Strapi
    runs-on: ubuntu-latest
    environment: production
    if: github.event_name == 'push' || github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'strapi'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: strapi/package-lock.json

      - name: Install dependencies
        working-directory: strapi
        run: npm ci

      - name: Build Strapi
        working-directory: strapi
        run: npm run build

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy to production server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          # Create deployment script
          cat > deploy-strapi.sh << 'SCRIPT'
          #!/bin/bash
          set -e

          echo "üöÄ Starting Strapi deployment..."

          # Create backups directory if it doesn't exist
          mkdir -p /var/www/backups

          # Backup current deployment
          if [ -d "/var/www/strapi/dist" ]; then
            echo "üì¶ Creating backup..."
            BACKUP_DIR="/var/www/backups/strapi-$(date +%Y%m%d-%H%M%S)"
            mkdir -p "$BACKUP_DIR"
            cp -r /var/www/strapi/dist "$BACKUP_DIR/" 2>/dev/null || true
            cp -r /var/www/strapi/config "$BACKUP_DIR/" 2>/dev/null || true
            echo "‚úÖ Backup created at: $BACKUP_DIR"
          fi

          # Navigate to deployment directory
          cd /var/www/strapi

          # Stop PM2 process gracefully
          echo "‚è∏Ô∏è  Stopping PM2 process..."
          pm2 stop strapi || true

          # Clean old build (preserve uploads and database)
          echo "üßπ Cleaning old build..."
          rm -rf dist
          rm -rf .strapi
          rm -rf .tmp/*.db 2>/dev/null || true

          echo "‚úÖ Deployment preparation complete"
          SCRIPT

          chmod +x deploy-strapi.sh

          # Execute deployment preparation on server
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p ${SSH_PORT:-22} ${SSH_USER}@${SSH_HOST} 'bash -s' < deploy-strapi.sh

          # Sync built files to server
          echo "üì§ Syncing files to server..."

          # Sync dist folder
          sshpass -p "$SSH_PASSWORD" rsync -avz -e "ssh -o StrictHostKeyChecking=no -p ${SSH_PORT:-22}" \
            --delete \
            strapi/dist/ ${SSH_USER}@${SSH_HOST}:/var/www/strapi/dist/

          # Sync source files
          sshpass -p "$SSH_PASSWORD" rsync -avz -e "ssh -o StrictHostKeyChecking=no -p ${SSH_PORT:-22}" \
            --delete \
            strapi/src/ ${SSH_USER}@${SSH_HOST}:/var/www/strapi/src/

          # Sync config files
          sshpass -p "$SSH_PASSWORD" rsync -avz -e "ssh -o StrictHostKeyChecking=no -p ${SSH_PORT:-22}" \
            --delete \
            strapi/config/ ${SSH_USER}@${SSH_HOST}:/var/www/strapi/config/

          # Sync database migrations (preserve actual database)
          sshpass -p "$SSH_PASSWORD" rsync -avz -e "ssh -o StrictHostKeyChecking=no -p ${SSH_PORT:-22}" \
            strapi/database/migrations/ ${SSH_USER}@${SSH_HOST}:/var/www/strapi/database/migrations/

          # Sync package files
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -P ${SSH_PORT:-22} \
            strapi/package.json \
            strapi/package-lock.json \
            strapi/tsconfig.json \
            strapi/ecosystem.config.js \
            ${SSH_USER}@${SSH_HOST}:/var/www/strapi/

          # Create post-deployment script
          cat > post-deploy-strapi.sh << 'SCRIPT'
          #!/bin/bash
          set -e

          cd /var/www/strapi

          # Install production dependencies
          echo "üì¶ Installing production dependencies..."
          npm ci --production --ignore-scripts

          # Ensure proper permissions
          echo "üîí Setting permissions..."
          chown -R www-data:www-data public/uploads 2>/dev/null || true
          chown -R www-data:www-data .tmp 2>/dev/null || true

          # Start PM2 process
          echo "‚ñ∂Ô∏è  Starting PM2 process..."
          pm2 start ecosystem.config.js || pm2 restart strapi

          # Save PM2 configuration
          pm2 save

          # Show PM2 status
          echo "üìä PM2 Status:"
          pm2 list

          echo "‚úÖ Strapi deployment complete!"
          SCRIPT

          chmod +x post-deploy-strapi.sh

          # Execute post-deployment on server
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p ${SSH_PORT:-22} ${SSH_USER}@${SSH_HOST} 'bash -s' < post-deploy-strapi.sh

          echo "üéâ Strapi deployed successfully!"

  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-strapi]
    if: always()

    steps:
      - name: Check deployment status
        run: |
          echo "üéØ Deployment Summary:"
          echo "Frontend: ${{ needs.deploy-frontend.result }}"
          echo "Strapi: ${{ needs.deploy-strapi.result }}"

          if [ "${{ needs.deploy-frontend.result }}" == "success" ] && [ "${{ needs.deploy-strapi.result }}" == "success" ]; then
            echo "‚úÖ All deployments successful!"
          elif [ "${{ needs.deploy-frontend.result }}" == "skipped" ] || [ "${{ needs.deploy-strapi.result }}" == "skipped" ]; then
            echo "‚è≠Ô∏è Some deployments were skipped"
          else
            echo "‚ùå Some deployments failed!"
            exit 1
          fi
